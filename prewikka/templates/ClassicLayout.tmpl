#from prewikka import env
#from prewikka.utils import nameToPath
#extends prewikka.templates.TopLayout

#def body_class()
classic_body
#end def

#block toplayout_content
#filter CleanOutput
<script type="text/javascript">

function check_same_origin(url) {
    /*
     * Force url.hostname to be defined in IE9
     * (problem with dynamically created links)
     */
    if ( ! url.hostname )
        url.href = url.href;

    /*
     * When the default port is used in IE9,
     * location.port is empty but url.port is not
     */
    default_port = {"http:": "80", "https:": "443"};
    return url.protocol == location.protocol && url.hostname == location.hostname && (url.port || default_port[url.protocol]) == (location.port || default_port[location.protocol]);
}

\$(document).ready(function() {
        prewikka_loadTab({url: "$document.fullhref", data: "$document.query_string", type: "$document.request_method"});

        /*
         * Back/Forward support.
         */
        \$(window).on("popstate", function(e) {
                if ( e.originalEvent.state == null )
                        return;

                prewikka_loadTab({url: e.originalEvent.state, history:false});
        });

        \$(document).on("click", "a, area", function(event) {
                var url = \$(this).attr('href');

                if ( ! url || url.indexOf("#") != -1 )
                        return;

                if ( ! check_same_origin(this) ) {
                        window.open(url, "$env.external_link_target");
                        return false;
                }

                if ( ! \$(this).hasClass("widget-link") )
                        prewikka_loadTab({ url: url });
                else
                        prewikka_widget({ url: url, dialog: { title: \$(this).attr('title') }});

                return false;
        });

        \$(document).on("click", ":input.widget-link", function() {
                prewikka_widget({
                        url: \$(this).closest("form").attr("action"),
                        dialog: { title: \$(this).attr("title") }
                });

                return false;
        });

        \$(document).on("submit", "#main form", function() {
                \$(this).find("input[name=_download]").remove();

                var data = \$(this).serialize();

                if ( \$(this).data("clicked") ) {
                        data += "&" + \$(this).data("clicked");
                        \$(this).removeData("clicked");
                }

                if ( \$(this).data("enable-download") ) {
                        \$(this).removeData("enable-download");
                        \$(this).append('<input type="hidden" name="_download" value="true" />');

                        /* No AJAX for download */
                        return true;
                }

                prewikka_loadTab({
                        url: \$(this).attr("action"),
                        type: \$(this).attr("method"),
                        data: data
                });

                return false;
        });

        \$(document).on("click", "#main form input[type=submit]", function() {
                var name = \$(this).attr("name");
                var value = \$(this).attr("value");

                if ( name && value )
                        \$(this).closest("form").data("clicked", encodeURIComponent(name) + "=" + encodeURIComponent(value));
        });
});
</script>

<div id="topmenu">
 #for $section in $interface.sections.keys():
  #set $style = ""
  #if $section != $interface.active_section
  #set $style="display:none;"
  #end if

  <div style="padding: 0px; margin: 0px; $style" class="topmenu_section" id="topmenu_$nameToPath($section)">
  #for $name, $views in $interface.sections.get($section).items()
    #set $firstview = $views.values()[0]
    #if $prewikka.user and not $prewikka.user.has($firstview.view_permissions):
      #continue
    #end if

    #if $name == $interface.active_tab
      #set $class_ = 'topmenu_item_active'
    #else
      #set $class_ = ''
    #end if

    <div class="topmenu_item $class_"><p><a href="$firstview.view_path" class="topmenu_links">$_($name)</a></p></div>
  #end for
  </div>
 #end for

  #end filter

  <div class="topmenu_item_special">
  <button type="button" id="help-button" title="$_("Help")"></button>
  <button type="button" id="maximize-button" title="$_("Maximize")"></button>
  #if $prewikka.logout_link
  <button type="button" id="logout-button" title="$_("Logout")" onclick="location.href='${document.base_url}$prewikka.logout_link'"></button>
  #end if
  </div>

  <div class="topmenu_item_user">
    #set $lnk = $document.base_url + "usersettingsdisplay"
    #if $varExists("prewikka.user.name")
     #set $title = $_('%s account') % $prewikka.user.name
     <p><b><a class="widget-link" title="$title" href="$lnk">$prewikka.user_display</a></b></p>
    #end if
  </div>
  #filter CleanOutput

</div>
#end filter

#filter Filter

<script type="text/javascript">
\$(document).ready(function() {
  \$("#maximize-button").click(function() {
	\$("#top_view").toggleClass("maximized");
  });

  \$("span.menu_item_delimiter").on("click", function() {
    \$(this).nextUntil("span").slideToggle();
    \$(this).siblings("span.menu_item_delimiter").nextUntil("span").slideUp();
  });

  \$("a.menu_item_active").prevAll("span.menu_item_delimiter").first().click();

});

</script>

#end filter

#filter CleanOutput
<div id="menu">
  #set $style = ''
  #for $name, $tabs in $interface.sections.items()
    #if $name == $interface.active_section
      #set $class_ = 'menu_item_active'
    #else
      #set $class_ = 'menu_item_inactive'
    #end if

    #set $link = ""
    #for $tab, $views in $tabs.items()
        #set $firstview = $views.values()[0]
        #if $prewikka.user and not $prewikka.user.has($firstview.view_permissions):
            #continue
        #end if

        #set $link = $firstview.view_path
        #break
    #end for

    #if not $tabs
      ## Display a delimiter if the section has no tabs
      <span class="menu_item_delimiter">$_($name)</span>
      #set $style = 'display:none;'
    #else if $link
      ## Display a clickable section if an accessible tab was found
      <a class="menu_item menu_item_$nameToPath(name) $class_" href="$link" style="$style">$_($name)</a>
    ##else
      ## Do not display the section, the user miss the necessary permissions
    #end if
  #end for

#end filter

<span>
## Empty span for section (un)folding
</span>

</div>
<div id="_main_viewport"></div>
<div id="_main">
 <div id="ajax-spinner" class="ajax-spinner" style="display:none;">
  <img id="img-spinner" src="prewikka/images/ajax-loader.gif" alt="Loading"/>
 </div>
 <div id="main" class="content" />
</div>

#end block toplayout_content
