#extends prewikka.templates.MessageListing

#block message_fields_header

<thead>
<script>
function del_entry(link) {
	row = link.parentNode.parentNode
	table = row.parentNode
	if ( ! row.nextSibling ) {
                row.previousSibling.lastChild.appendChild(row.lastChild.firstChild)
	}

	table.removeChild(row)	
}

function simple_add_entry(name, object, value) {
	table = document.getElementById(name)

	if ( table.lastChild && table.lastChild.nodeName == "TR" ) {
		table.lastChild.lastChild.removeChild(table.lastChild.lastChild.lastChild)
	}

	row = document.createElement("tr")
	table.appendChild(row)

	field = document.createElement("td")
	row.appendChild(field)
	input = document.createElement("input")
	field.appendChild(input)
	input.setAttribute("name", object)
	input.setAttribute("value", value)
	
	field = document.createElement("td")
	row.appendChild(field)

	if ( table.firstChild != table.lastChild ) {
		link = document.createElement("a")
		link.setAttribute("onclick", "del_entry(this)")
		content = document.createTextNode("-")
		link.appendChild(content)
		field.appendChild(link)		
	} else {
		content = document.createTextNode(" ")
		field.appendChild(content)
	}

	field = document.createElement("td")
	row.appendChild(field)
	link = document.createElement("a")
	link.setAttribute("onclick", "simple_add_entry('" + name + "', '" + object + "', '')")
	content = document.createTextNode("+")
	link.appendChild(content)
	field.appendChild(link)
}

function direction_add_entry(direction_type, node_type, value, num) {
	table = document.getElementById(direction_type)

	if ( table.lastChild && table.lastChild.nodeName == "TR" ) {
		table.lastChild.lastChild.removeChild(table.lastChild.lastChild.lastChild)
	}

	row = document.createElement("tr")
	table.appendChild(row)

	field = document.createElement("td")
	row.appendChild(field)
	select = document.createElement("select")
	field.appendChild(select)
	select.setAttribute("name", direction_type + "_type_" + num)

	option = document.createElement("option")
	option.setAttribute("value", "alert." + direction_type + ".node.address.address")
	if ( node_type == "alert." + direction_type + ".node.address.address" ) {
		option.setAttribute("selected", "true")
	}
	option_value = document.createTextNode("address")
	option.appendChild(option_value)
	select.appendChild(option)

	option = document.createElement("option")
	option.setAttribute("value", "alert." + direction_type + ".node.name")
	if ( node_type == "alert." + direction_type + ".node.name" ) {
		option.setAttribute("selected", "true")
	}
	option_value = document.createTextNode("hostname")
	option.appendChild(option_value)
	select.appendChild(option)

	field = document.createElement("td")
	row.appendChild(field)
	input = document.createElement("input")
	field.appendChild(input)
	input.setAttribute("name", "alert." + direction_type  + ".node_" + num)
	input.setAttribute("value", value)

	field = document.createElement("td")
	row.appendChild(field)

	if ( table.firstChild != table.lastChild ) {
		link = document.createElement("a")
		link.setAttribute("onclick", "del_entry(this)")
		content = document.createTextNode("-")
		link.appendChild(content)
		field.appendChild(link)		
	} else {
		content = document.createTextNode(" ")
		field.appendChild(content)
	}

	field = document.createElement("td")
	row.appendChild(field)
	link = document.createElement("a")
	link.setAttribute("onclick",
                          "direction_add_entry('" + direction_type + "', '" + node_type + "', '', '" + (num + 1) + "')")
	content = document.createTextNode("+")
	link.appendChild(content)
	field.appendChild(link)
}

</script>
<tr>
  <td class="filter_popup">
    <a onclick="javascript:toggleFilteredColumnVisibility('classification')">Classification</a>
    <table id="classification"></table>
    <script>
      #for $classification in $alert.classification.text
        simple_add_entry('classification', 'alert.classification.text', '$classification')
      #end for
    </script>
    #if $classification_filtered
      <span>*</span>
    #end if
  </td>

  <td class="filter_popup">
    <a onclick="javascript:toggleFilteredColumnVisibility('source')">Source</a>
    <table id="source"></table>
    <script>
      #set $cnt = 0
      #for $type, $value in $alert.source.node
        direction_add_entry('source', '$type', '$value', $cnt)
	#set $cnt = $cnt + 1
      #end for
    </script>
    #if $source_filtered
      <span>*</span>
    #end if
  </td>

  <td class="filter_popup">
    <a onclick="javascript:toggleFilteredColumnVisibility('target')">Target</a>
    <table id="target"></table>
    <script>
      #set $cnt = 0
      #for $type, $value in $alert.target.node
        direction_add_entry('target', '$type', '$value', $cnt)
	#set $cnt = $cnt + 1
      #end for
    </script>
    #if $target_filtered
      <span>*</span>
    #end if
  </td>
  
  <td class="filter_popup">
    <a onclick="javascript:toggleFilteredColumnVisibility('analyzer')">Sensor</a>
    <table id="analyzer"></table>
    <script>
      #for $analyzer in $alert.analyzer.name
        simple_add_entry('analyzer', 'alert.analyzer.name', '$analyzer')
      #end for
    </script>
    #if $analyzer_filtered
      <span>*</span>
    #end if
  </td>

  <td>Time</td>

  <td>
    <input src="img/search.png" type="image" style="border: 0"/>
  </td>
</tr>
</thead>
#end block message_fields_header

#block message_fields
#set $class_ = "impact_severity_" + $message.severity.value

<td>
 <ul id="popup_block">
  <li><span class="$class_">$message.classification.value</span>
  #if $message.completion.value
      (<span class="impact_completion_$message.completion.value">$message.completion.value</span>)
  #end if
      <br/>$message.classification_references
   <ul>
    <li><a href="$message.details">Alert detail</a></li>
    <li><a href="$message.summary">Alert summary</a></li>
    <li><a href="$message.classification.inline_filter">Group by classification</a></li>
   </ul>
  </li>
 </ul>
</td>

<td>
  <ul id="popup_block">
    <li class="popup_title">
      #if $message.sservice.value
        <span>$message.source.value</span>:$message.sservice.value
	#if $message.sservice_extra.value
          ($message.sservice_extra.value)
        #end if
      #else
        <span>$message.source.value</span>
      #end if
      #if $message.source_extra.value
        <br/>($message.source_extra.value)
      #end if
      #if $message.suser_name.value
        <br/>user: $message.suser_name.value
	#if $message.suser_uid.value != None
	  ($message.suser_uid.value)
	#end if
      #end if
      #if $message.sprocess_name.value
        <br/>process: $message.sprocess_name.value
	#if $message.sprocess_pid.value != None
	  ($message.sprocess_pid.value)
	#end if
      #end if
     #if $message.sinterface.value
        <br/>interface: $message.sinterface.value
     #end if
      <ul>
        <li><a href="$message.source.inline_filter">Group by source</a></li>
        #for $name, $link in $message.source.host_commands
          <li><a href="$link">$name</a></li>
        #end for
      </ul>
    </li>
  </ul>
</td>

<td>
  <ul id="popup_block">
    <li class="popup_title">
      #if $message.tservice.value
        <span>$message.target.value</span>:$message.tservice.value
        #if $message.tservice_extra.value
          ($message.tservice_extra.value)
        #end if
      #else
        <span>$message.target.value</span>
      #end if
      #if $message.target_extra.value
        <br/>($message.target_extra.value)
      #end if
      #if $message.tuser_name.value
        <br/>user: $message.tuser_name.value
	#if $message.tuser_uid.value != None
	  ($message.tuser_uid.value)
	#end if
      #end if
      #if $message.tprocess_name.value
        <br/>process: $message.tprocess_name.value
	#if $message.tprocess_pid.value != None
	  ($message.tprocess_pid.value)
	#end if
      #end if
     #if $message.tinterface.value
        <br/>interface: $message.tinterface.value
     #end if
      <ul>
        <li><a href="$message.target.inline_filter">Group by target</a></li>
        #for $name, $link in $message.target.host_commands
          <li><a href="$link">$name</a></li>
        #end for
      </ul>
    </li>
  </ul>
</td>

<td>
  <a href='$message.sensor.inline_filter'>$message.sensor.value</a>
  #if $message.sensor_node_name.value
    (on $message.sensor_node_name.value)
  #end if
</td>
<td>$message.time.value</td>
#end block message_fields

#block timeline_extra_content
<tr>
  <td id="filter_control_label">Filter: </td>
  <td colspan='2'>
  <select name='filter' size="1" class="filter_control_select">
  <option value=""/>
  #for $fltr in $filters
    #if $fltr == $current_filter
      #set $selected = "selected"
    #else
      #set $selected = ""
    #end if
    <option value='$fltr' $selected/>$fltr
  #end for
  </td>
#end block
