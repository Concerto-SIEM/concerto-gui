#from prewikka import User, utils
#extends prewikka.templates.MessageListing

#block message_fields_header

#set $row_classes = ("table_row_even", "table_row_odd")
#set $global_cnt = 0


<thead>
<script type="text/javascript">

<!-- 
function del_entry(link) {
	row = link.parentNode.parentNode
	table = row.parentNode
	if ( ! row.nextSibling ) {
                row.previousSibling.lastChild.appendChild(row.lastChild.firstChild)
	}

	table.removeChild(row)	
}

function simple_add_entry(table_name, object, value) {
	table = document.getElementById(table_name)

	if ( table.lastChild && table.lastChild.nodeName == "TR" ) {
		table.lastChild.lastChild.removeChild(table.lastChild.lastChild.lastChild)
	}

	row = document.createElement("tr")
	table.appendChild(row)

	field = document.createElement("th")
	row.appendChild(field)

	input = document.createElement("input")
	input.setAttribute("name", object)
	input.setAttribute("value", value)
	field.appendChild(input)

//	field = document.createElement("td")
//	row.appendChild(field)

	if ( table.firstChild != table.lastChild ) {
		link = document.createElement("a")
		link.setAttribute("onclick", "del_entry(this)")
		link.setAttribute("href", "")
		content = document.createTextNode("-")
		link.appendChild(content)
		field.appendChild(link)		
	} else {
		content = document.createTextNode(" ")
		field.appendChild(content)
	}

	field = document.createElement("td")
	row.appendChild(field)

	link = document.createElement("a")
	link.setAttribute("onclick", "simple_add_entry('" + table_name + "', '" + object + "', '')")
	link.setAttribute("href", "")
	
	content = document.createTextNode("+")
	link.appendChild(content)
	field.appendChild(link)
}

function begin(table) {
	if ( table.lastChild && table.lastChild.nodeName == "TR" ) {
		table.lastChild.lastChild.removeChild(table.lastChild.lastChild.lastChild)
	}

	row = document.createElement("tr")
	table.appendChild(row)
        
        field = document.createElement("th")
	row.appendChild(field)
        content = document.createTextNode("Group entry by")
        field.appendChild(content)
        
        field = document.createElement("td")
	row.appendChild(field)
	select = document.createElement("select")
 	field.appendChild(select)
}

function end(table) {
	field = document.createElement("td")
	row.appendChild(field)

	if ( table.firstChild != table.lastChild ) {
		link = document.createElement("a")
		link.setAttribute("onclick", "del_entry(this)")
		link.setAttribute("href", "")
		content = document.createTextNode("-")
		link.appendChild(content)
		field.appendChild(link)		
	} else {
		content = document.createTextNode(" ")
		field.appendChild(content)
	}

	field = document.createElement("td")
	row.appendChild(field)
}

#for $category, $aggregations in $available_aggregations.items()
function aggregated_${category}_add_entry(path) {
	table = document.getElementById("${category}_aggregation_table")

	begin(table);
	select.setAttribute("name", "aggregated_${category}")
        
        #for $aggregation_name, $aggregated_path in $aggregations
        
	option = document.createElement("option")
	option.setAttribute("value", '$aggregated_path')
	if ( path == '$aggregated_path' ) {
		option.setAttribute("selected", "true")
	}
	option_value = document.createTextNode('$aggregation_name')
	option.appendChild(option_value)
	select.appendChild(option)
        
        #end for
	
	field = document.createElement("td")
	row.appendChild(field)

	if ( table.firstChild != table.lastChild ) {
		link = document.createElement("a")
		link.setAttribute("onclick", "del_entry(this)")
		link.setAttribute("href", "#")
		content = document.createTextNode("-")
		link.appendChild(content)
		field.appendChild(link)		
	} else {
		content = document.createTextNode(" ")
		field.appendChild(content)
	}

	end(table)

	link = document.createElement("a")
	link.setAttribute("onclick", "aggregated_${category}_add_entry('')")
	link.setAttribute("href", "#")
	content = document.createTextNode("+")
	link.appendChild(content)
	field.appendChild(link)
}
#end for

#for $name, $objects in (
			  ("classification", (("text", "alert.classification.text"), )
                          ),

                          ("analyzer", (("name", "alert.analyzer.name"), 
                                        ("node location", "alert.analyzer.node.location"), 
                                        ("node address", "alert.analyzer.node.address.address"), 
                                        ("node name", "alert.analyzer.node.name"), 
                                        ("manufacturer", "alert.analyzer.manufacturer"), 
                                        ("model", "alert.analyzer.model"), 
                                        ("class", "alert.analyzer.class"))
                          ), 

                          ("source", (("address", "alert.source.node.address.address"), 
                                      ("name", "alert.source.node.name"), 
                                      ("user", "alert.source.user.user_id.name"), 
                                      ("process", "alert.source.process.name"), 
                                      ("service", "alert.source.service.name"), 
                                      ("port", "alert.source.service.port"), 
                                      ("interface", "alert.source.interface"))
                          ), 
 
                          ("target", (("address", "alert.target.node.address.address"), 
                                      ("name", "alert.target.node.name"), 
                                      ("user", "alert.target.user.user_id.name"), 
                                      ("process", "alert.target.process.name"), 
                                      ("service", "alert.target.service.name"), 
                                      ("port", "alert.target.service.port"), 
                                      ("interface", "alert.target.interface"))
                          )
)

function ${name}_add_entry(object, value, num) {
	table = document.getElementById('${name}_table')

	if ( table.lastChild && table.lastChild.nodeName == "TR" ) {
		table.lastChild.lastChild.removeChild(table.lastChild.lastChild.lastChild)
	}

	row = document.createElement("tr")
	table.appendChild(row)

	field = document.createElement("th")
	content = document.createTextNode("Filter on:")
	field.appendChild(content)
	row.appendChild(field)
	
	field = document.createElement("td")
	row.appendChild(field)
	select = document.createElement("select")
	field.appendChild(select)
	select.setAttribute("name", "${name}_object_" + num)
        
#for $object_name, $object in $objects
        
	option = document.createElement("option")
	option.setAttribute("value", '$object')
	if ( object == '$object' ) {
		option.setAttribute("selected", "true")
	}
	option_value = document.createTextNode('$object_name')
	option.appendChild(option_value)
	select.appendChild(option)
        
#end for

	field = document.createElement("td")
	row.appendChild(field)
	input = document.createElement("input")
	field.appendChild(input)
	input.setAttribute("name", '${name}_value_' + num)
	input.setAttribute("value", value)

	field = document.createElement("td")
	row.appendChild(field)

	if ( table.firstChild != table.lastChild ) {
		link = document.createElement("a")
		link.setAttribute("onclick", "del_entry(this)")
		content = document.createTextNode("-")
		link.setAttribute("href", "#")
		link.appendChild(content)
		field.appendChild(link)
	} else {
		content = document.createTextNode(" ")
		field.appendChild(content)
	}

	field = document.createElement("td")
	row.appendChild(field)
	link = document.createElement("a")
	link.setAttribute("onclick", "${name}_add_entry('', '', '" + (num + 1) + "')")
	link.setAttribute("href", "#")
	content = document.createTextNode("+")
	link.appendChild(content)
	field.appendChild(link)
}

#end for
-->

</script>

<tr>
  <td class="filter_popup">
    <a onclick="javascript:toggleFilteredColumnVisibility('classification');" href="#">Classification</a>
    <div id="classification">
      <table id="classification_table" style="width: 100%;"></table>
      <script type="text/javascript">
        #set $cnt = 0
        #for $object, $value in $classification
        #set $escaped_value = utils.escape_attribute($value)
          classification_add_entry('$object', '$escaped_value', $cnt)
          #set $cnt = $cnt + 1
          #set $global_cnt = $global_cnt + 1
        #end for
      </script>

      <table id="classification_aggregation_table"></table>
      <script type="text/javascript">
      #if len($aggregated_classification) == 0
        aggregated_classification_add_entry("")
        #set $global_cnt = $global_cnt + 1
      #else
        #for $path in $aggregated_classification
          aggregated_classification_add_entry('$path')
          #set $global_cnt = $global_cnt + 1
        #end for
      #end if
      </script>

      <table>
      <tr>
      #set $global_cnt += 1
       <th>Severity:</th>

      #if "info" in $alert.assessment.impact.severity
        #set $checked = "checked='checked'"
      #else
        #set $checked = ""
      #end if
      <td><input type="checkbox" name="alert.assessment.impact.severity" value="info" $checked />info</td>

      #if "low" in $alert.assessment.impact.severity
        #set $checked = "checked='checked'"
      #else
        #set $checked = ""
      #end if
      <td><input type="checkbox" name="alert.assessment.impact.severity" value="low" $checked />low</td>

      #if "medium" in $alert.assessment.impact.severity
        #set $checked = "checked='checked'"
      #else
        #set $checked = ""
      #end if
      <td><input type="checkbox" name="alert.assessment.impact.severity" value="medium" $checked />medium</td>

      #if "high" in $alert.assessment.impact.severity
        #set $checked = "checked='checked'"
      #else
        #set $checked = ""
      #end if
      <td><input type="checkbox" name="alert.assessment.impact.severity" value="high" $checked />high</td>
      
      #if "none" in $alert.assessment.impact.severity
        #set $checked = "checked='checked'"
      #else
        #set $checked = ""
      #end if
      <td><input type="checkbox" name="alert.assessment.impact.severity" value="none" $checked />none</td>

      </tr>

      <tr>
      #set $global_cnt += 1
       <th>Completion:</th>

      <td>&nbsp;</td>
      
      #if "succeeded" in $alert.assessment.impact.completion
        #set $checked = "checked='checked'"
      #else
        #set $checked = ""
      #end if
      <td colspan="2"><input type="checkbox" name="alert.assessment.impact.completion" value="succeeded" $checked />succeeded</td>
      
      #if "failed" in $alert.assessment.impact.completion
        #set $checked = "checked='checked'"
      #else
        #set $checked = ""
      #end if
      <td><input type="checkbox" name="alert.assessment.impact.completion" value="failed" $checked />failed</td>

      #if "none" in $alert.assessment.impact.completion
        #set $checked = "checked='checked'"
      #else
        #set $checked = ""
      #end if
      <td><input type="checkbox" name="alert.assessment.impact.completion" value="none" $checked />none</td>
    </tr>
    </table>
    </div>

    #if $classification_filtered
      <span>*</span>
    #end if
  </td>

  <td class="filter_popup">
    <a onclick="javascript:toggleFilteredColumnVisibility('source');" href="#">Source</a>
    <div id="source">
      <table id="source_table"></table>
      <script type="text/javascript">
        #set $cnt = 0
        #for $object, $value in $source
        #set $escaped_value = utils.escape_attribute($value)
          source_add_entry('$object', '$escaped_value', $cnt)
          #set $global_cnt = $global_cnt + 1
        #end for
      </script>
      <table id="source_aggregation_table"></table>
      <script type="text/javascript">
      #if len($aggregated_source) == 0
        aggregated_source_add_entry("")
        #set $global_cnt = $global_cnt + 1
      #else
        #for $path in $aggregated_source
          aggregated_source_add_entry('$path')
	  #set $global_cnt = $global_cnt + 1
        #end for
      #end if
      </script>
    </div>
    #if $source_filtered
      <span>*</span>
    #end if
  </td>

  <td class="filter_popup">
    <a onclick="javascript:toggleFilteredColumnVisibility('target');" href="#">Target</a>
    <div id="target">
      <table id="target_table"></table>
      <script type="text/javascript">
        #set $cnt = 0
        #for $object, $value in $target
        #set $escaped_value = utils.escape_attribute($value)
          target_add_entry('$object', '$escaped_value', $cnt)
          #set $global_cnt += 1
          #set $cnt = $cnt + 1
        #end for
      </script>
      <table id="target_aggregation_table"></table>
      <script type="text/javascript">
      #if len($aggregated_target) == 0
        aggregated_target_add_entry("")
        #set $global_cnt += 1
      #else
        #for $path in $aggregated_target
          aggregated_target_add_entry('$path')
          #set $global_cnt += 1
        #end for
      #end if
      </script>
    </div>
    #if $target_filtered
      <span>*</span>
    #end if
  </td>
  
  <td class="filter_popup">
    <a onclick="javascript:toggleFilteredColumnVisibility('analyzer');" href="#">Sensor</a>
    <div id="analyzer">
    <table id="analyzer_table"></table>
        <script  type="text/javascript">
          #set $cnt = 0
          #for $object, $value in $analyzer
          #set $escaped_value = utils.escape_attribute($value)
            analyzer_add_entry('$object', '$escaped_value', $cnt)
            #set $global_cnt += 1
            #set $cnt = $cnt + 1
          #end for
        </script>
    </div>
    #if $analyzer_filtered
      <span>*</span>
    #end if
  </td>

  <td>Time</td>

  <td>
    <input src="prewikka/images/search.png" type="image" style="border: 0;" />
  </td>
</tr>
</thead>
#end block message_fields_header


#block message_fields

<td>
  #if $message.aggregated and $message.aggregated_classifications_hidden > 0
    <b>($message.aggregated_classifications_hidden/$message.aggregated_classifications_total alerts not shown...
    <a href="$message.aggregated_classifications_hidden_expand">expand</a>)</b>
    <br/>
  #end if
  #for $info in $message.infos
    #if $message.aggregated and (len($message.infos) > 1 or $info.count > 1)
      $info.count x
    #end if
     <a class="impact_severity_$info.severity.value" href="$info.display">
     #if $info.classification.value
       $info.classification.value
     #else
       n/a
     #end if
     </a>
    #if $info.completion.value
      (<span class="impact_completion_$info.completion.value">$info.completion.value</span>)
    #end if
      <br/>$info.classification_references
  #end for
</td>

#for $name, $separator, $direction in ("source", "from", $message.source), ("target", "to", $message.target)
<td>
      #set $service = ""
      #set $proto_param = ""
      #set $proto_str = ""

      #if $direction.service.value != None
       #if $direction.service_extra.value != None
        #set $proto_str = "/" + $direction.service_extra.value.lower()
        #set $proto_param = "&amp;protocol=" + $direction.service_extra.value.upper() 
       #end if

       #set $service = ":<a href='http://www.portsdb.org/bin/portsdb.cgi?portnumber="
       #set $service += $str($direction.service.value) + $proto_param + "'>" + $str($direction.service.value) + $proto_str + "</a>"
      #end if
   
      #for $address in $direction.addresses
       <ul class="popup_block">
        <li class="popup_title">
         <span>$address.value</span>$service

	  <ul>
           <li><a href="$address.inline_filter">Filter on this $name</a></li>
           #for $cmdname, $link in $address.host_commands
           <li><a href="$link">$cmdname</a></li>
           #end for
          </ul>
	 </li>
        </ul>
       #end for

      #if $direction.users
        #if len($direction.users) > 1
          users:
        #else
          user:
        #end if

        #set $cnt = 0
        #for $user in $direction.users
          #if $cnt > 0
            ;&nbsp;
          #end if
          
	  $user.user.value    

          #if $user.user_extra.value
            ($user.user_extra.value)
          #end if
      
          #set $cnt = $cnt + 1
        #end for
      #end if

      #if $direction.process.value
        process: $direction.process.value
        #if $direction.process_extra.value != None
          ($direction.process_extra.value)
        #end if
      #end if

     #if $direction.interface.value
        interface: $direction.interface.value
     #end if

     #if $direction.empty
       n/a
     #end if
</td>
#end for

<td>
  #for $sensor in $message.sensors
    <a href='$sensor.name.inline_filter'>$sensor.name.value</a>
    #if $sensor.node_name.value
      ($sensor.node_name.value)
    #end if
    <br/>
  #end for
</td>
<td>
  #if $message.aggregated
    #if $message.time_min.value == $message.time_max.value
      $message.time_min.value
    #else
      $message.time_max.value -
      $message.time_min.value
    #end if
  #else
    $message.time.value
    #if $message.analyzer_time.value
      (sent at $message.analyzer_time.value)
    #end if
  #end if
</td>

#end block message_fields

#block timeline_extra_content
<tr>
  <td id="filter_control_label">Filter: </td>
  <td colspan='2'>
  <select name='filter' size="1" class="filter_control_select">
  <option value=""/>
  #for $fltr in $filters
    #if $fltr == $current_filter
      #set $selected = "selected='selected'"
    #else
      #set $selected = ""
    #end if
    <option value='$fltr' $selected>$fltr</option>
  #end for
  </select>
  </td>
</tr>
#end block
