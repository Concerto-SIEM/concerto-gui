#from prewikka import User, utils
#extends prewikka.templates.MessageListing

#block head_extra_content
#filter CleanOutput 

<script type="text/javascript">

<!-- 
function del_entry(link) {
	row = link.parentNode.parentNode
	table = row.parentNode
	if ( ! row.nextSibling ) {
                row.previousSibling.lastChild.appendChild(row.lastChild.firstChild)
	}

	table.removeChild(row)	
}

function end(row) {
	field = document.createElement("td")
	field.setAttribute("width", "11px")
	row.appendChild(field)

	if ( row.firstChild != row.lastChild ) {
		link = document.createElement("a")
		link.onclick = function(){ del_entry(this) }
		content = document.createTextNode("-")
		link.appendChild(content)
		field.appendChild(link)		
	} else {
		content = document.createTextNode(" ")
		field.appendChild(content)
	}
}

function get_operator_option(select, operator)
{
#end filter
#for $operator, $desc in (("=", $_("Equal")), ("<", $_("Lesser than")), 
                          (">", $_("Greater than")), ("<=", $_("Lesser or equal")), 
                          (">=", $_("Greater or equal")), ("<>", $_("Substring")), 
			  ("<>*", $_("Substring (case-insensitive)")), ("~", $_("Regular expression")), ("~*", $_("Regular expression (case-insensitive)")))
        option = document.createElement("option")

        option.setAttribute("value", '$operator')
	option.setAttribute("title", '$desc')
        if ( operator == '$operator' ) {
                option.setAttribute("selected", "true")
        }
        option_value = document.createTextNode('$operator')
        option.appendChild(option_value)
        select.appendChild(option)
#end for
#filter CleanOutput

}



options_array = new Array()
functions_array = new Array()


function del_td(name, num)
{
        old = document.getElementById("td_" + name + num)
        if ( ! old )
                return

        row = old.parentNode
                
        td = document.createElement("td")
        td.setAttribute("id", "td_" + name + num)

        row.insertBefore(td, old)
        row.removeChild(old)
}


function filter_add_list(value, object, name, num) {
        td = document.getElementById("td_" + name + num)
        
        var opt;

        select = document.createElement("select")
        select.setAttribute("name", name + '_value_' + num)
        select.setAttribute("class", "popup_input_field")
        td.appendChild(select)
        
        for (key in options_array[object]) {
                option = document.createElement("option")
                
                if ( options_array[object][key] == value ) {
                        option.setAttribute("selected", "true")
                }
                
                option_value = document.createTextNode(options_array[object][key])
	        option.appendChild(option_value)
	        select.appendChild(option)
        }
}

function filter_add_input(value, object, name, num) {
        td = document.getElementById("td_" + name + num)
        
        input = document.createElement("input")
	input.setAttribute("class", "popup_input_field")
	input.setAttribute("name", name + '_value_' + num)
	input.setAttribute("type", "text")
	input.setAttribute("value", value)
        td.appendChild(input)
}



#for $category, $aggregations in (
                          ("classification", $classification_aggregations),
                          ("analyzer", $analyzer_aggregations),
                          ("source", $source_aggregations),
                          ("target", $target_aggregations)
)


function aggregated_${category}_add_entry(path) {
	table = document.getElementById("${category}_aggregation_table")

        if ( table.lastChild && table.lastChild.nodeName == "TR" ) {
                table.lastChild.lastChild.removeChild(table.lastChild.lastChild.lastChild)
        }

        row = document.createElement("tr")
        table.appendChild(row)

        field = document.createElement("th")
        row.appendChild(field)
        content = document.createTextNode("$_('Group entry by:')")
        field.appendChild(content)

        field = document.createElement("td")
        row.appendChild(field)
        field = document.createElement("td")
        row.appendChild(field)

        field = document.createElement("td")
        row.appendChild(field)
        select = document.createElement("select")
        field.appendChild(select)

	select.setAttribute("class", "popup_input_field")
	select.setAttribute("name", "aggregated_${category}")
        
        #for $aggregation_name, $aggregated_path, $unused in $aggregations

        option = document.createElement("option")

#if $aggregated_path == None
        option.setAttribute("disabled", "disabled")
#else
        option.setAttribute("value", '$aggregated_path')
        if ( path == '$aggregated_path' ) {
                option.setAttribute("selected", "true")
        }
#end if

	option_value = document.createTextNode('$aggregation_name')
	option.appendChild(option_value)
	select.appendChild(option)
        
        #end for

	end(row)
	field = document.createElement("td")
	field.setAttribute("width", "11px")
	row.appendChild(field)

	link = document.createElement("a")
	link.onclick = function(){ aggregated_${category}_add_entry('') }
	content = document.createTextNode("+")
	link.appendChild(content)
	field.appendChild(link)
}
#end for

#for $name, $objects in (
			  ("classification", $classification_filters),
                          ("analyzer", $analyzer_filters), 
                          ("source", $source_filters),
                          ("target", $target_filters),
)

function ${name}_add_entry(object, operator, value, num) {
	table = document.getElementById('${name}_table')

	if ( table.lastChild && table.lastChild.nodeName == "TR" ) {
		table.lastChild.lastChild.removeChild(table.lastChild.lastChild.lastChild)
	}

	row = document.createElement("tr")
	table.appendChild(row)

	field = document.createElement("th")
	content = document.createTextNode("$_('Filter on:')")
	field.appendChild(content)
	row.appendChild(field)
	
	field = document.createElement("td")
	row.appendChild(field)
	select = document.createElement("select")
	field.appendChild(select)

	select.setAttribute("class", "popup_select_field")
	select.setAttribute("name", "${name}_object_" + num)
        select.onchange = function() { del_td('${name}', num); functions_array[this.options[this.selectedIndex].value](value, this.options[this.selectedIndex].value, '${name}', num) }
        
        var add_default
        var add_default_object
        
#for $object_name, $object, $obval in $objects        
	option = document.createElement("option")

#if $obval == None
        func = filter_add_input
#else
        func = filter_add_list
        options_array["$object"] = new Array()

        #set $cnt = 0
        #for $opt in $obval
                options_array["$object"][$cnt] = '${opt}'
                #set $cnt += 1
        #end for
#end if

#if $object == None
	option.setAttribute("disabled", "disabled")
	option.setAttribute("value", '')
#else
	option.setAttribute("value", '$object')
	if ( object == '$object' || ! object ) {
		option.setAttribute("selected", "true")
		add_default = func
		add_default_object = '$object'
		object = '$object'
	}
#end if

	option_value = document.createTextNode('$object_name')
	option.appendChild(option_value)
	select.appendChild(option)


        functions_array["$object"] = func
#end for

        field = document.createElement("td")
        row.appendChild(field)        
        select = document.createElement("select")
        field.appendChild(select)
	select.setAttribute("class", "popup_operator_select")
        select.setAttribute("name", "${name}_operator_" + num)
        
        if ( ! operator )
                operator = "<>*";
                
        get_operator_option(select, operator)

	field = document.createElement("td")
	field.setAttribute("id", "td_$name" + num)
	row.appendChild(field)

        if (add_default) {
                add_default(value, add_default_object, '${name}', num);
        }
                
	end(row)
	
	field = document.createElement("td")
	field.setAttribute("width", "11px")
	row.appendChild(field)
	link = document.createElement("a")
	link.onclick = function(){ ${name}_add_entry('', '', '', (num + 1)) };
	content = document.createTextNode("+")
	link.appendChild(content)
	field.appendChild(link)
}

#end for
//--></script>

#end filter 
#filter Filter
#end filter
#end block


#block message_fields_header

<thead>
<tr style="height: 20px;">
  <th class="filter_popup">
    <a>$_("Classification")</a>
    <div id="classification">
     <table>
      <tr><td><table class="inline_filter_content"><tbody id="classification_table"></tbody></table></td></tr>
      <tr><td><table class="inline_filter_content"><tbody id="classification_aggregation_table"></tbody></table></td></tr>
      <tr><td>
      <table class="inline_filter_content">
      <tr>
       <th>$_("Type:")</th>
       <td>&nbsp;</td>
      #if $correlation_alert_view
       #set $disabled="disabled=\"disabled\""
      #else
       #set $disabled=""
      #end if
      
      #for name, path in (($N_("Alert"), "alert.create_time"), ($N_("CorrelationAlert"), "alert.correlation_alert.name"), 
                          ($N_("OverflowAlert"), "alert.overflow_alert.program"), ($N_("ToolAlert"), "alert.tool_alert.name"))
        #if path in $alert.type
         #set $checked = "checked='checked'"
        #else
         #set $checked = ""
        #end if
        
        <td>$_($name)<input class="checkbox" $disabled type="checkbox" name="alert.type" value="$path" $checked /></td>
      #end for
      </tr>


      <tr>
       <th>$_("Severity:")</th>
      #for $item in $N_("info"), $N_("low"), $N_("medium"), $N_("high"), $N_("none")
        #if $item in $alert.assessment.impact.severity
         #set $checked = "checked='checked'"
        #else
         #set $checked = ""
        #end if
        <td>$_($item)<input class="checkbox" type="checkbox" name="alert.assessment.impact.severity" value="$item" $checked /></td>
      #end for
      </tr>

      <tr>
       <th>$_("Completion:")</th>  
       <td colspan="2">&nbsp;</td>
       
      #for item in $N_("succeeded"), $N_("failed"), $N_("none")
        #if item in $alert.assessment.impact.completion
         #set $checked = "checked='checked'"
        #else
         #set $checked = ""
        #end if
        <td>$_($item)<input class="checkbox" type="checkbox" name="alert.assessment.impact.completion" value="$item" $checked /></td>
      #end for
      
    </tr>
    </table>
      </td></tr>
     </table>

      <script type="text/javascript">
        #set $cnt = 0
        #for $object, $operator, $value in $classification
          classification_add_entry("$object", "$operator", "$utils.escape_attribute($value)", $cnt)
          #set $cnt = $cnt + 1
        #end for

      #if len($aggregated_classification) == 0
        aggregated_classification_add_entry("")
      #else
        #for $path in $aggregated_classification
          aggregated_classification_add_entry('$path')
        #end for
      #end if
      </script>
    </div>

    #if $classification_filtered
      <span class="filter_enabled_marker">*</span>
    #end if
  </th>

  <th class="filter_popup">
    <a>$_("Source")</a>
    <div id="source">
     <table>
      <tr><td><table class="inline_filter_content"><tbody id="source_table"></tbody></table></td></tr>
      <tr><td><table class="inline_filter_content"><tbody id="source_aggregation_table"></tbody></table></td></tr>
     </table>
     
     <script type="text/javascript">
        #set $cnt = 0
        #for $object, $operator, $value in $source
          source_add_entry("$object", "$operator", "$utils.escape_attribute($value)", $cnt)
	  #set $cnt += 1
        #end for

      #if len($aggregated_source) == 0
        aggregated_source_add_entry("")
      #else
        #for $path in $aggregated_source
          aggregated_source_add_entry('$path')
        #end for
      #end if
     </script>
    </div>
    #if $source_filtered
      <span class="filter_enabled_marker">*</span>
    #end if
  </th>

  <th class="filter_popup">
    <a>$_("Target")</a>
    <div id="target">
     <table>
      <tr><td><table class="inline_filter_content"><tbody id="target_table"></tbody></table></td></tr>
      <tr><td><table class="inline_filter_content"><tbody id="target_aggregation_table"></tbody></table></td></tr>
     </table>
     <script type="text/javascript">
        #set $cnt = 0
        #for $object, $operator, $value in $target
          target_add_entry("$object", "$operator", "$utils.escape_attribute($value)", $cnt)
          #set $cnt = $cnt + 1
        #end for

      #if len($aggregated_target) == 0
        aggregated_target_add_entry("")
      #else
        #for $path in $aggregated_target
          aggregated_target_add_entry('$path')
        #end for
      #end if
     </script>
    </div>
    #if $target_filtered
      <span class="filter_enabled_marker">*</span>
    #end if
  </th>
  
  <th class="filter_popup">
    <a>$_("Sensor")</a>
    <div id="analyzer">
     <table>
      <tr><td><table class="inline_filter_content"><tbody id="analyzer_table"></tbody></table></td></tr>
      <tr><td><table class="inline_filter_content"><tbody id="analyzer_aggregation_table"></tbody></table></td></tr>
     </table>

     <script  type="text/javascript">
      #set $cnt = 0
      #for $object, $operator, $value in $analyzer
       analyzer_add_entry("$object", "$operator", "$utils.escape_attribute($value)", $cnt)
       #set $cnt = $cnt + 1
      #end for

      #if len($aggregated_analyzer) == 0
        aggregated_analyzer_add_entry("")
      #else
        #for $path in $aggregated_analyzer
          aggregated_analyzer_add_entry('$path')
        #end for
      #end if
     </script>
    </div>
    #if $analyzer_filtered
      <span class="filter_enabled_marker">*</span>
    #end if
  </th>

  <td>$_("Time")</td>
</tr>
</thead>
#end block message_fields_header


#block message_fields
#filter CleanOutput

<td>
  #if $message.sub_alert_name
    <b>$message.sub_alert_type#slurp
    #if $message.sub_alert_display
      #set $string = $ngettext("alert", "alerts", $message.sub_alert_number)
      (<a href="$message.sub_alert_display">$message.sub_alert_number</a> $string)#slurp
    #end if
:</b> <i><a href="$message.sub_alert_link">$message.sub_alert_name</a></i><br/>#slurp
  #end if

  #if $message.aggregated and $message.aggregated_classifications_hidden > 0
    #set $string = $_("%(hidden)d of %(total)d alerts not shown...")
    <b>($str($string % { "hidden": $message.aggregated_classifications_hidden, "total": $message.aggregated_classifications_total })
    <a href="$message.aggregated_classifications_hidden_expand">$_("expand")</a>)</b>
    <br/>
  #end if

  #for $info in $message.infos
    #if $message.aggregated and (len($message.infos) > 1 or $info.count > 1)
      $info.count x
    #end if
    
    #if $info.classification.value
      <a class="impact_severity_$info.severity.value" href="$info.display">$info.classification.value</a>
    #else
      <a class="impact_severity_$info.severity.value" href="$info.display">n/a</a>
    #end if

    #if $info.completion.value
      (<span class="impact_completion_$info.completion.value">$info.completion.value</span>)
    #end if

    <br/>
    #set $sep = "("
#for url, name in $info.classification_references##slurp
#if $url#$sep<a target="$prewikka.external_link_target" href="$url">$name</a>#else#$sep$name#end if##slurp
      #set $sep = ", "
#end for##if $info.classification_references#)#end if
  #end for
</td>

#for $name, $direction, $hidden, $total, $expand in ($_("source"), $message.source, $message.aggregated_source_hidden, $message.aggregated_source_total, $message.aggregated_source_expand), ($_("target"), $message.target, $message.aggregated_target_hidden, $message.aggregated_target_total, $message.aggregated_target_expand)
<td>
#if len($direction) == 0
       n/a
#end if

#set $need_hr = 0

#if $hidden > 0
       #set $string = $_("%(hidden)d of %(total)d %(name)ss not shown...")
       <b>($str($string % { "hidden": $hidden, "total": $total, "name": $name })
       <a href="$expand">$_("expand")</a>)</b>
       <br/>
#end if

#for $direction in $direction 
      #if $need_hr
	<hr style="border: 1px dashed #808080; margin-top: 3px; margin-bottom: 0px;" />
      #end if

      #set $need_hr = 1
      #set $service = ""
      #set $proto_param = ""
      #set $proto_str = ""
    
      #if $direction.protocol.value != None
       #set $proto_str = $direction.protocol.value.lower()
       #set $proto_param = "&amp;protocol=" + $direction.protocol.value.upper() 
      #end if

      #for $address in $direction.addresses
       <a class="popup_menu_toggle">$address.value</a><span class="popup_menu">
         - <a href="$address.inline_filter">$str($_("Filter on this %s") % ($name))</a><br />

       #if not $address.category or $address.category in ("ipv4-addr", "ipv4-net", "ipv6-addr", "ipv6-net")
         - <a target="$prewikka.external_link_target" href="https://www.prelude-ids.com/host_details.php?host=$address.value">$str($_("%s information") % ($name)).capitalize()</a><br />

          #for $cmdname, $link in $address.host_commands
         - <a href="$link">$cmdname</a><br />
          #end for
       #end if
       </span>#slurp
#if $direction.service.value != None#:<a target="$prewikka.external_link_target" href="https://www.prelude-ids.com/port_details.php?port=$str($direction.service.value)$proto_param">$str($direction.service.value)#slurp
         #if $proto_str
/$proto_str</a>
         #else 
</a>
         #end if
       #elif $proto_str
:$proto_str
       #end if
<br />
      #end for
     
      #if $len($direction.addresses) == 0 and $service
	service: $service[1:]
      #end if

     #set $cnt = 0
     #for $name, $value, $extra in $direction.listed_values
         #if $cnt > 0
          <br />
         #end if

         $name: <a href="$value.inline_filter">$value.value</a>
         #if $extra != None
          ($extra)
         #end if
         
         #set $cnt += 1
     #end for
#end for

</td>
#end for

<td>
  #for $sensor in $message.sensors
    #if $sensor.name.value
      <a href="$sensor.name.inline_filter">$sensor.name.value</a>
    #end if
    #if $sensor.node_name.value
      (<a href="$sensor.node_name.inline_filter">$sensor.node_name.value</a>)
    #end if
    <br/>
  #end for
</td>
<td>
  #if $message.aggregated
    #if $message.time_min.value == $message.time_max.value
      $message.time_min.value
    #else
      $message.time_max.value -
      $message.time_min.value
    #end if
  #else
    $message.time.value
    #if $message.analyzer_time.value
      (sent at $message.analyzer_time.value)
    #end if
  #end if
</td>
#end filter
#filter Filter
#end filter
#end block message_fields

#block timeline_extra_content
#filter CleanOutput
<tr>
  <th id="filter_control_label">$_("Filter")</th>
  <td colspan="2">
   <select name="filter" size="1" class="filter_control_select">
    <option value="">&nbsp;</option>
  #for $fltr in $filters
    <option value="$fltr" #if $fltr == $current_filter# selected="selected" #end if#>$fltr</option>
  #end for
  </select>
 </td>
</tr>
#end filter
#filter Filter
#end filter
#end block
