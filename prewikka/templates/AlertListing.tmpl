#from prewikka import User, utils
#extends prewikka.templates.MessageListing

#block head_extra_content
#filter CleanOutput

<script type="text/javascript">

<!-- 
function del_entry(link) {
	row = link.parentNode.parentNode
	table = row.parentNode
	if ( ! row.nextSibling ) {
                row.previousSibling.lastChild.appendChild(row.lastChild.firstChild)
	}

	table.removeChild(row)	
}

function end(row) {
	field = document.createElement("td")
	field.setAttribute("width", "11px")
	row.appendChild(field)

	if ( row.firstChild != row.lastChild ) {
		link = document.createElement("a")
		link.onclick = function(){ del_entry(this) }
		link.setAttribute("href", "#")
		content = document.createTextNode("-")
		link.appendChild(content)
		field.appendChild(link)		
	} else {
		content = document.createTextNode(" ")
		field.appendChild(content)
	}
}

#for $category, $aggregations in $available_aggregations.items()
function aggregated_${category}_add_entry(path) {
	table = document.getElementById("${category}_aggregation_table")

        if ( table.lastChild && table.lastChild.nodeName == "TR" ) {
                table.lastChild.lastChild.removeChild(table.lastChild.lastChild.lastChild)
        }

        row = document.createElement("tr")
        table.appendChild(row)

        field = document.createElement("th")
        row.appendChild(field)
        content = document.createTextNode("Group entry by:")
        field.appendChild(content)

        field = document.createElement("td")
        row.appendChild(field)
        select = document.createElement("select")
        field.appendChild(select)

	select.setAttribute("name", "aggregated_${category}")
        
        #for $aggregation_name, $aggregated_path in $aggregations
        
	option = document.createElement("option")
	option.setAttribute("value", '$aggregated_path')
	if ( path == '$aggregated_path' ) {
		option.setAttribute("selected", "true")
	}
	option_value = document.createTextNode('$aggregation_name')
	option.appendChild(option_value)
	select.appendChild(option)
        
        #end for

	end(row)
	field = document.createElement("td")
	field.setAttribute("width", "11px")
	row.appendChild(field)

	link = document.createElement("a")
	link.onclick = function(){ aggregated_${category}_add_entry('') }
	link.setAttribute("href", "#")
	content = document.createTextNode("+")
	link.appendChild(content)
	field.appendChild(link)
}
#end for

#for $name, $objects in (
			  ("classification", (("text", "alert.classification.text"), 
					      ("messageid", "alert.messageid"))
                          ),

                          ("analyzer", (("name", "alert.analyzer.name"), 
                                        ("node location", "alert.analyzer.node.location"), 
                                        ("node address", "alert.analyzer.node.address.address"), 
                                        ("node name", "alert.analyzer.node.name"), 
                                        ("manufacturer", "alert.analyzer.manufacturer"), 
                                        ("model", "alert.analyzer.model"), 
                                        ("class", "alert.analyzer.class"),
					("analyzerid", "alert.analyzer.analyzerid"))
                          ), 

                          ("source", (("address", "alert.source.node.address.address"), 
                                      ("node name", "alert.source.node.name"), 
                                      ("user", "alert.source.user.user_id.name"), 
                                      ("process", "alert.source.process.name"), 
                                      ("service", "alert.source.service.name"), 
                                      ("port", "alert.source.service.port"), 
                                      ("interface", "alert.source.interface"))
                          ), 
 
                          ("target", (("address", "alert.target.node.address.address"), 
                                      ("node name", "alert.target.node.name"), 
                                      ("user", "alert.target.user.user_id.name"), 
                                      ("process", "alert.target.process.name"), 
                                      ("service", "alert.target.service.name"), 
                                      ("port", "alert.target.service.port"), 
                                      ("interface", "alert.target.interface"),
				      ("file path", "alert.target.file.path"))
                          )
)

function ${name}_add_entry(object, value, num) {
	table = document.getElementById('${name}_table')

	if ( table.lastChild && table.lastChild.nodeName == "TR" ) {
		table.lastChild.lastChild.removeChild(table.lastChild.lastChild.lastChild)
	}

	row = document.createElement("tr")
	table.appendChild(row)

	field = document.createElement("th")
	content = document.createTextNode("Filter on:")
	field.appendChild(content)
	row.appendChild(field)
	
	field = document.createElement("td")
	row.appendChild(field)
	select = document.createElement("select")
	field.appendChild(select)
	select.setAttribute("name", "${name}_object_" + num)
        
#for $object_name, $object in $objects
        
	option = document.createElement("option")
	option.setAttribute("value", '$object')
	if ( object == '$object' ) {
		option.setAttribute("selected", "true")
	}
	option_value = document.createTextNode('$object_name')
	option.appendChild(option_value)
	select.appendChild(option)
        
#end for

	field = document.createElement("td")
	row.appendChild(field)
	input = document.createElement("input")
	field.appendChild(input)
	input.setAttribute("name", '${name}_value_' + num)
	input.setAttribute("value", value)

	end(row)
	
	field = document.createElement("td")
	field.setAttribute("width", "11px")
	row.appendChild(field)
	link = document.createElement("a")
	link.onclick = function(){ ${name}_add_entry('', '', (num + 1)) };
	link.setAttribute("href", "#")
	content = document.createTextNode("+")
	link.appendChild(content)
	field.appendChild(link)
}

#end for
//--></script>

#filter Filter
#end block


#block message_fields_header
#set global $address_cnt = 0

<thead>
<tr>
  <td class="filter_popup">
    <a onclick="javascript:toggleFilteredColumnVisibility('classification');" href="#">Classification</a>
    <div id="classification">
      <table style="width: 100%;"><tbody id="classification_table" style="width: 100%;"></tbody></table>
      <script type="text/javascript">
        #set $cnt = 0
        #for $object, $value in $classification
          classification_add_entry("$object", "$utils.escape_attribute($value)", $cnt)
          #set $cnt = $cnt + 1
        #end for
      </script>

      <table style="width: 100%;"><tbody id="classification_aggregation_table"></tbody></table>
      <script type="text/javascript">
      #if len($aggregated_classification) == 0
        aggregated_classification_add_entry("")
      #else
        #for $path in $aggregated_classification
          aggregated_classification_add_entry('$path')
        #end for
      #end if
      </script>

      <table style="width: 100%;">
      <tr>
       <th>Severity:</th>

      #if "info" in $alert.assessment.impact.severity
        #set $checked = "checked='checked'"
      #else
        #set $checked = ""
      #end if
      <td><input class="checkbox" type="checkbox" name="alert.assessment.impact.severity" value="info" $checked />info</td>

      #if "low" in $alert.assessment.impact.severity
        #set $checked = "checked='checked'"
      #else
        #set $checked = ""
      #end if
      <td><input class="checkbox" type="checkbox" name="alert.assessment.impact.severity" value="low" $checked />low</td>

      #if "medium" in $alert.assessment.impact.severity
        #set $checked = "checked='checked'"
      #else
        #set $checked = ""
      #end if
      <td><input class="checkbox" type="checkbox" name="alert.assessment.impact.severity" value="medium" $checked />medium</td>

      #if "high" in $alert.assessment.impact.severity
        #set $checked = "checked='checked'"
      #else
        #set $checked = ""
      #end if
      <td><input class="checkbox" type="checkbox" name="alert.assessment.impact.severity" value="high" $checked />high</td>
      
      #if "none" in $alert.assessment.impact.severity
        #set $checked = "checked='checked'"
      #else
        #set $checked = ""
      #end if
      <td><input class="checkbox" type="checkbox" name="alert.assessment.impact.severity" value="none" $checked />none</td>

      </tr>

      <tr>
       <th>Completion:</th>

      <td>&nbsp;</td>
      
      #if "succeeded" in $alert.assessment.impact.completion
        #set $checked = "checked='checked'"
      #else
        #set $checked = ""
      #end if
      <td colspan="2"><input class="checkbox" type="checkbox" name="alert.assessment.impact.completion" value="succeeded" $checked />succeeded</td>
      
      #if "failed" in $alert.assessment.impact.completion
        #set $checked = "checked='checked'"
      #else
        #set $checked = ""
      #end if
      <td><input class="checkbox" type="checkbox" name="alert.assessment.impact.completion" value="failed" $checked />failed</td>

      #if "none" in $alert.assessment.impact.completion
        #set $checked = "checked='checked'"
      #else
        #set $checked = ""
      #end if
      <td><input class="checkbox" type="checkbox" name="alert.assessment.impact.completion" value="none" $checked />none</td>
    </tr>
    </table>
    </div>

    #if $classification_filtered
      <span class="filter_enabled_marker">*</span>
    #end if
  </td>

  <td class="filter_popup">
    <a onclick="javascript:toggleFilteredColumnVisibility('source');" href="#">Source</a>
    <div id="source">
      <table style="width: 100%;"><tbody id="source_table"></tbody></table>
      <script type="text/javascript">
        #set $cnt = 0
        #for $object, $value in $source
          source_add_entry("$object", "$utils.escape_attribute($value)", $cnt)
	  #set $cnt += 1
        #end for
      </script>
      <table style="width: 100%;"><tbody id="source_aggregation_table"></tbody></table>
      <script type="text/javascript">
      #if len($aggregated_source) == 0
        aggregated_source_add_entry("")
      #else
        #for $path in $aggregated_source
          aggregated_source_add_entry('$path')
        #end for
      #end if
      </script>
    </div>
    #if $source_filtered
      <span class="filter_enabled_marker">*</span>
    #end if
  </td>

  <td class="filter_popup">
    <a onclick="javascript:toggleFilteredColumnVisibility('target');" href="#">Target</a>
    <div id="target">
      <table style="width: 100%;"><tbody id="target_table"></tbody></table>
      <script type="text/javascript">
        #set $cnt = 0
        #for $object, $value in $target
          target_add_entry("$object", "$utils.escape_attribute($value)", $cnt)
          #set $cnt = $cnt + 1
        #end for
      </script>
      <table style="width: 100%;"><tbody id="target_aggregation_table"></tbody></table>
      <script type="text/javascript">
      #if len($aggregated_target) == 0
        aggregated_target_add_entry("")
      #else
        #for $path in $aggregated_target
          aggregated_target_add_entry('$path')
        #end for
      #end if
      </script>
    </div>
    #if $target_filtered
      <span class="filter_enabled_marker">*</span>
    #end if
  </td>
  
  <td class="filter_popup">
    <a onclick="javascript:toggleFilteredColumnVisibility('analyzer');" href="#">Sensor</a>
    <div id="analyzer">
    <table style="width: 100%;"><tbody id="analyzer_table"></tbody></table>
        <script  type="text/javascript">
          #set $cnt = 0
          #for $object, $value in $analyzer
            analyzer_add_entry("$object", "$utils.escape_attribute($value)", $cnt)
            #set $cnt = $cnt + 1
          #end for
        </script>
    </div>
    #if $analyzer_filtered
      <span class="filter_enabled_marker">*</span>
    #end if
  </td>

  <td>Time</td>

  <td>
    <input src="prewikka/images/search.png" type="image" style="border: 0;" />
  </td>
</tr>
</thead>
#end block message_fields_header


#block message_fields
<td>
  #if $message.correlation_alert_name
    <b>Correlation Alert#slurp
    #if $message.correlated_alert_display
      #set plural = ""
      #if $message.correlated_alert_number > 1:
          #set plural = "s"
      #end if
      (<a href="$message.correlated_alert_display">$message.correlated_alert_number</a> alert$plural)#slurp
    #end if
:</b> <i><a href="$message.correlation_alert_link">$message.correlation_alert_name</a></i><br/>#slurp
  #end if

  #if $message.aggregated and $message.aggregated_classifications_hidden > 0
    <b>($message.aggregated_classifications_hidden/$message.aggregated_classifications_total alerts not shown...
    <a href="$message.aggregated_classifications_hidden_expand">expand</a>)</b>
    <br/>
  #end if

  #for $info in $message.infos
    #if $message.aggregated and (len($message.infos) > 1 or $info.count > 1)
      $info.count x
    #end if
     
    #if $info.classification.value
      <a class="impact_severity_$info.severity.value" href="$info.display">$info.classification.value</a>
    #else
      <a class="impact_severity_$info.severity.value" href="$info.display">n/a</a>
    #end if

    #if $info.completion.value
      (<span class="impact_completion_$info.completion.value">$info.completion.value</span>)
    #end if

    <br/>$info.classification_references
  #end for
</td>

#for $name, $direction in ("source", $message.source), ("target", $message.target)
<td>
#if len($direction) == 0
       n/a
#end if

#set $need_hr = 0

#for $direction in $direction      
      #if $need_hr
	<hr style="border: 1px dashed #808080; margin-top: 3px; margin-bottom: 0px;" />
      #end if

      #set $need_hr = 1
      #set $service = ""
      #set $proto_param = ""
      #set $proto_str = ""
    
      #if $direction.protocol.value != None
       #set $proto_str = $direction.protocol.value.lower()
       #set $proto_param = "&amp;protocol=" + $direction.protocol.value.upper() 
      #end if

      #for $address in $direction.addresses
       <a href="#" onclick="javascript:toggleVisibilityUnique('menu_$address_cnt'); return false;">$address.value</a>#slurp
       #if $direction.service.value != None
:<a target="$prewikka.external_link_target" href="https://www.prelude-ids.com/port_details.php?port=$str($direction.service.value)$proto_param">$str($direction.service.value)#slurp
         #if $proto_str
/$proto_str</a>
         #else 
</a>
         #end if
       #elif $proto_str
:$proto_str
       #end if
<br />

       <span id="menu_$address_cnt" class="popup_menu">
       #set global $address_cnt += 1

         - <a href="$address.inline_filter">Filter on this $name</a><br />
 
       #if not $address.category or $address.category in ("ipv4-addr", "ipv4-net", "ipv6-addr", "ipv6-net")
         - <a target="$prewikka.external_link_target" href="https://www.prelude-ids.com/host_details.php?host=$address.value">$name.capitalize() information</a><br />

          #for $cmdname, $link in $address.host_commands
         - <a href="$link">$cmdname</a><br />
          #end for
       #end if

       </span>
      #end for
     
      #if $len($direction.addresses) == 0 and $service
	service: $service[1:]
      #end if

      #if $direction.users
        #if len($direction.users) > 1
          users:
        #else
          user:
        #end if

        #set $cnt = 0
        #for $user in $direction.users
          #if $cnt > 0
            ;&nbsp;
          #end if
          
	  $user.user.value    

          #if $user.user_extra.value != None
            ($user.user_extra.value)
          #end if
      
          #set $cnt = $cnt + 1
        #end for
      #end if

      #if $direction.process.value
        process: $direction.process.value
        #if $direction.process_extra.value != None
          ($direction.process_extra.value)
        #end if
      #end if

     #if $direction.interface.value
        interface: $direction.interface.value
     #end if

     #set $cnt = 0
     #for $file in $direction.files
       #if $cnt > 0
         <br />
       #end if

       <a href="$file.inline_filter">$file.value</a>
       #set $cnt = $cnt + 1
     #end for
#end for

</td>
#end for

<td>
  #for $sensor in $message.sensors
    <a href="$sensor.name.inline_filter">$sensor.name.value</a>
    #if $sensor.node_name.value
      ($sensor.node_name.value)
    #end if
    <br/>
  #end for
</td>
<td>
  #if $message.aggregated
    #if $message.time_min.value == $message.time_max.value
      $message.time_min.value
    #else
      $message.time_max.value -
      $message.time_min.value
    #end if
  #else
    $message.time.value
    #if $message.analyzer_time.value
      (sent at $message.analyzer_time.value)
    #end if
  #end if
</td>
#end block message_fields

#block timeline_extra_content
#filter CleanOutput
<tr>
  <td id="filter_control_label">Filter: </td>
  <td colspan="3">
  <select name="filter" size="1" class="filter_control_select">
  <option value="">&nbsp;</option>
  #for $fltr in $filters
    #if $fltr == $current_filter
      #set $selected = "selected=\"selected\""
    #else
      #set $selected = ""
    #end if
    <option value="$fltr" $selected>$fltr</option>
  #end for
  </select>
  </td>
</tr>
#filter Filter
#end block
